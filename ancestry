#!/bin/bash

###
#      STEP 1
#
# Find the input vcf/ped file and convert it to me.ped
#
# Idea: Standardizing filename and file type for later processing in the pipeline
###

echo Finding and processing input file...

input="$(ls | egrep -e ".vcf|.vcf.gz|.ped")"

echo $input
if [[ "$input" == *ped ]] 
then
    filename="$(echo $input | cut -f1 -d.)" 
    ./plink --file $filename --recode --out me > run.log
elif [ "$input" == *vcf ] || [ "$input" == *gz ] ;
then
    ./plink --vcf $input --maf 0.05 --recode --out me > run.log 2>error.log
else
    echo No vcf/ped file found in the current directory
    exit 1
fi


###
#      STEP 2
# Accept binary/multiple workflow pipeline
#
###

echo
echo
echo Binary Ancestry Option is 1 
echo Continental Ancestry Option is 2
echo
echo Which ancestry do you want to check

read option


####
#       STEP 3
#  - merge individual's genotype to reference panel
#  - run admixture on merged bed with corresponding merged pop file
#  - the generated Q file is analyzed by R script which generates the final ancestry results
####

if [ $option = "1" ]; then
    
    ./plink --noweb --bfile reference_panel/yri --merge me --make-bed --out binary_merge1 >> run.log 2>>error.log


    if [ ! -f binary_merge1.bed ]; # If the merge was unsuccessful
    then
        echo Yo
        ./plink --file me --exclude binary_merge1-temp.missnp --make-bed --out me_temp >> run.log 2>>error.log
        ./plink --bfile reference_panel/yri --bmerge me_temp --make-bed --out binary_merge1 >> run.log 2>>error.log
    fi

    ./plink --bfile binary_merge1 --geno 0.999 --make-bed --out binary_merge >> run.log 2>>error.log

    ./admixture -j5 --supervised binary_merge.bed 2 >> run.log 2>>error.log
   
    Rscript plots/plotBinary.R 1>>error.log
    
    echo
    echo Correlations are given below for and against
else
    ./plink --noweb --bfile reference_panel/PAP --merge me --make-bed --out merge1 >> run.log 2>>error.log
    
    ./plink --bfile merge1 -geno 0.999 --make-bed --out merge >> run.log 2>>error.log

    ./admixture -j5 --supervised merge.bed 9 >> run.log 2>>error.log >> run.log 2>>error.log
    
    Rscript plots/plot.R 1>>error.log

    echo
    echo Correlations are given below
fi

echo
cat ancestry.txt
rm -f merge1.bed merge1.fam merge1.bim merge.bed merge.fam merge.bim
rm -f me.ped me.map me.log
